@* Itinerary Modal *@
<div class="modal-overlay" id="itineraryModal" style="display: none;">
    <div class="itinerary-modal-dialog">
        <div class="itinerary-modal-content">
            <!-- Header -->
            <div class="itinerary-header">
                <h1 class="header-title">Itinerary</h1>
                <button class="close-btn" onclick="closeItineraryModal()">✕</button>
            </div>

            <!-- Modal Body with Scroll -->
            <div class="itinerary-modal-body">
                <!-- Shareholder Info -->
                <div class="shareholder-info">
                    <div class="info-group">
                        <label class="info-label">Shareholder Name</label>
                        <input type="text" class="info-input" id="itinerary_shareholderName" readonly>
                    </div>
                    <div class="info-group">
                        <label class="info-label">Folion ID</label>
                        <input type="text" class="info-input folio-id" id="itinerary_folioId" readonly>
                    </div>
                </div>

                <!-- Itinerary Details Card -->
                <div class="itinerary-card">

                    <div class="card-header">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M20 7H4C2.89543 7 2 7.89543 2 9V19C2 20.1046 2.89543 21 4 21H20C21.1046 21 22 20.1046 22 19V9C22 7.89543 21.1046 7 20 7Z" stroke="white" stroke-width="2" />
                            <path d="M16 21V5C16 4.46957 15.7893 3.96086 15.4142 3.58579C15.0391 3.21071 14.5304 3 14 3H10C9.46957 3 8.96086 3.21071 8.58579 3.58579C8.21071 3.96086 8 4.46957 8 5V21" stroke="white" stroke-width="2" />
                        </svg>
                        <h2 class="card-title">Itinerary Details</h2>
                    </div>

                    <div class="itinerary-content">
                        <div class="route-section">
                            <div class="route-badge">
                                <span class="route-text" id="detail_route">-</span>
                            </div>
                        </div>

                        <div class="details-table">
                            <div class="details-row">
                                <div class="details-cell">
                                    <div class="cell-label">Passenger Name</div>
                                    <div class="cell-value" id="detail_passengerName">-</div>
                                </div>
                                <div class="details-cell">
                                    <div class="cell-label">Ticket Type</div>
                                    <div class="cell-value" id="detail_ticketType">-</div>
                                </div>
                                <div class="details-cell">
                                    <div class="cell-label">Relationship</div>
                                    <div class="cell-value" id="detail_relationship">-</div>
                                </div>
                                <div class="details-cell">
                                    <div class="cell-label">Ticket Issue</div>
                                    <div class="cell-value" id="detail_ticketIssue">-</div>
                                </div>
                            </div>

                            <div class="details-row">
                                <div class="details-cell">
                                    <div class="cell-label">Ticket No</div>
                                    <div class="cell-value" id="detail_ticketNo">-</div>
                                </div>
                                <div class="details-cell">
                                    <div class="cell-label">Passport</div>
                                    <div class="cell-value" id="detail_passport">-</div>
                                </div>
                                <div class="details-cell">
                                    <div class="cell-label">Departure</div>
                                    <div class="cell-value" id="detail_departure">-</div>
                                </div>
                                <div class="details-cell">
                                    <div class="cell-label">Return</div>
                                    <div class="cell-value" id="detail_return">-</div>
                                </div>
                                <div class="details-cell">
                                    <div class="cell-label">Entitlement</div>
                                    <div class="cell-value" id="detail_entitlement">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trip Request Section -->
                <div class="trip-request-section">
                    <div class="airline-image-container">
                        <img src="~/assets/ItineraryImage.png" alt="SriLankan Airlines" class="airline-image">
                    </div>

                    <div class="trip-request-form">
                        <!-- Form 1: Trip Request -->
                        <div id="tripRequestForm1" class="trip-form-step">
                            <div class="form-header">
                                <h3 class="form-title">Trip Request</h3>
                            </div>

                            <div class="form-content">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Full Name</label>
                                        <input type="text" class="form-input" id="trip_fullName" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Ticket Type</label>
                                        <select class="form-select" id="trip_ticketType">
                                            <option value="Shareholder">Shareholder</option>
                                            <option value="Dependent">Dependent</option>
                                            <option value="Spouse">Spouse</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Relationship</label>
                                        <input type="text" class="form-input" id="trip_relationship" placeholder="Enter Relationship">
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Remarks</label>
                                        <input type="text" class="form-input" id="trip_remarks" placeholder="Type Remarks">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Ticket Issue</label>
                                        <input type="number" class="form-input" id="trip_ticketIssue" value="01" min="1" max="99">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Entitlement</label>
                                        <input type="text" class="form-input" id="trip_entitlement" value="01">
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <button class="next-btn" onclick="showManageRequestForm()">
                                        Next
                                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                            <path d="M7.5 15L12.5 10L7.5 5" stroke="currentColor" stroke-width="2" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Form 2: Manage Request -->
                        <div id="tripRequestForm2" class="trip-form-step" style="display: none;">
                            <div class="form-header">
                                <h3 class="form-title">Manage Request</h3>
                            </div>

                            <div class="form-content">
                                <div class="form-row-2col">
                                    <div class="form-group">
                                        <label class="form-label">Ticket No</label>
                                        <input type="text" class="form-input" id="manage_ticketNo" value="603 1276597360" placeholder="Enter Ticket Number">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Select passport</label>
                                        <select class="form-select" id="manage_passport">
                                            <option value="">-- Select Passport --</option>
                                            <!-- Passports will be loaded dynamically -->
                                        </select>
                                    </div>
                                </div>

                                <div class="form-row-2col">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <img src="~/assets/takeoff.png" alt="departure" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 4px;">
                                            Departure Airport
                                        </label>
                                        <select class="form-select airport-select" id="manage_departureAirport">
                                            <option value="DXB" data-city="Dubai - United Arab Emirates" selected>DXB</option>
                                            <option value="CMB" data-city="Colombo - Sri Lanka">CMB</option>
                                            <option value="BKK" data-city="Bangkok - Thailand">BKK</option>
                                            <option value="SIN" data-city="Singapore">SIN</option>
                                            <option value="LHR" data-city="London - United Kingdom">LHR</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            <img src="~/assets/landing.png" alt="arrival" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 4px;">
                                            Arrival Airport
                                        </label>
                                        <select class="form-select airport-select" id="manage_arrivalAirport">
                                            <option value="PEK" data-city="Beijing - China" selected>PEK</option>
                                            <option value="CMB" data-city="Colombo - Sri Lanka">CMB</option>
                                            <option value="BKK" data-city="Bangkok - Thailand">BKK</option>
                                            <option value="SIN" data-city="Singapore">SIN</option>
                                            <option value="LHR" data-city="London - United Kingdom">LHR</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-row-2col">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                                <line x1="3" y1="10" x2="21" y2="10"></line>
                                            </svg>
                                            Departure Date
                                        </label>
                                        <input type="date" class="form-input" id="manage_departureDate" value="2024-08-07">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <polyline points="12 6 12 12 16 14"></polyline>
                                            </svg>
                                            Departure Time
                                        </label>
                                        <input type="time" class="form-input" id="manage_departureTime" value="10:00">
                                    </div>
                                </div>

                                <div class="form-row-2col">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                                <line x1="3" y1="10" x2="21" y2="10"></line>
                                            </svg>
                                            Return Date
                                        </label>
                                        <input type="date" class="form-input" id="manage_returnDate" value="2024-08-16">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <polyline points="12 6 12 12 16 14"></polyline>
                                            </svg>
                                            Return Time
                                        </label>
                                        <input type="time" class="form-input" id="manage_returnTime" value="18:00">
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <button class="back-btn" onclick="showTripRequestForm()">
                                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                            <path d="M12.5 15L7.5 10L12.5 5" stroke="currentColor" stroke-width="2" />
                                        </svg>
                                        Back
                                    </button>
                                    <button class="save-btn" onclick="saveTripRequest()">
                                        Save
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Booking History Section -->
                <div class="booking-history-section">
                    <div class="history-header">
                        <div class="aeroholder-brand">
                            <img src="~/assets/smallplane.png" alt="to" style="width: 16px; height: 16px; vertical-align: middle; margin: 0 4px;">
                            <span class="brand-name">AeroHolder</span>
                            <span class="brand-subtitle">Booking History</span>
                        </div>
                        <div class="search-box">
                            <input type="text" class="search-input" placeholder="">
                            <svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M9 17C13.4183 17 17 13.4183 17 9C17 4.58172 13.4183 1 9 1C4.58172 1 1 4.58172 1 9C1 13.4183 4.58172 17 9 17Z" stroke="#6b7280" stroke-width="2" />
                                <path d="M19 19L14.65 14.65" stroke="#6b7280" stroke-width="2" />
                            </svg>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="booking-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;"></th>
                                    <th>Updated-on</th>
                                    <th>From - To</th>
                                    <th>Travel Route</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Updated-by</th>
                                    <th>Passenger</th>
                                    <th style="text-align: center;">Tickets</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody id="bookingHistoryTableBody">
                                <tr>
                                    <td colspan="10" style="text-align: center; padding: 20px; color: #6b7280;">
                                        No booking history found. Save a trip request to see it here.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="pagination">
                        <button class="pagination-btn">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" />
                            </svg>
                            Prev
                        </button>
                        <button class="pagination-btn active">1</button>
                        <button class="pagination-btn">2</button>
                        <button class="pagination-btn">3</button>
                        <span class="pagination-dots">...</span>
                        <button class="pagination-btn">5</button>
                        <button class="pagination-btn">
                            Next
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Modal Overlay */
    .modal-overlay#itineraryModal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: fadeIn 0.2s ease;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .itinerary-modal-dialog {
        max-width: 900px;
        width: 100%;
        max-height: 95vh;
        display: flex;
        flex-direction: column;
        animation: slideUp 0.3s ease;
    }

    @@keyframes slideUp {
        from {
            transform: translateY(30px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .itinerary-modal-content {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        max-height: 95vh;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .itinerary-modal-body {
        overflow-y: auto;
        background: #e8eaf0;
        flex: 1;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

        .itinerary-modal-body::-webkit-scrollbar {
            display: none;
        }

    /* Header */
    .itinerary-header {
        background: #0F2E6B;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header-title {
        color: white;
        font-size: 16px;
        font-weight: 600;
        margin: 0;
    }

    .close-btn {
        background: transparent;
        border: none;
        color: white;
        font-size: 22px;
        cursor: pointer;
        padding: 0;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: background 0.2s;
    }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

    /* Shareholder Info */
    .shareholder-info {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 20px;
        padding: 16px 24px;
        background: white;
        margin: 0;
    }

    .info-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .info-label {
        font-size: 11px;
        color: #6b7280;
        font-weight: 500;
    }

    .info-input {
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 13px;
        background: white;
        color: #1f2937;
    }

        .info-input.folio-id {
            width: 150px;
        }

    /* Itinerary Card */
    .itinerary-card {
        background: white;
        margin: 16px 24px 16px 24px;
        border-radius: 8px;
        overflow: visible;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        position: relative;
    }

    .card-header {
        background: #0F2E6B;
        color: white;
        padding: 14px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .card-title {
        font-size: 16px;
        font-weight: 600;
        margin: 0;
    }

    .itinerary-content {
        padding: 16px 20px;
        background: #f8f9fa;
    }

    .route-section {
        margin-bottom: 14px;
    }

    .route-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: white;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .route-text {
        font-size: 13px;
        font-weight: 600;
        color: #1f2937;
    }

    .details-table {
        background: white;
        border-radius: 8px;
        overflow: hidden;
    }

    .details-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        border-bottom: 1px solid #e5e7eb;
    }

        .details-row:first-child {
            border-top: 1px solid #e5e7eb;
        }

        .details-row:last-child {
            grid-template-columns: repeat(5, 1fr);
            border-bottom: none;
        }

    .details-cell {
        padding: 12px 16px;
        border-right: 1px solid #e5e7eb;
    }

        .details-cell:last-child {
            border-right: none;
        }

    .cell-label {
        font-size: 10px;
        color: #6b7280;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        margin-bottom: 4px;
    }

    .cell-value {
        font-size: 12px;
        color: #1f2937;
        font-weight: 500;
    }

    /* Trip Request Section */
    .trip-request-section {
        margin: 0 24px 16px 24px;
        position: relative;
        height: 550px;
    }

    .airline-image-container {
        width: 100%;
        height: 100%;
        overflow: hidden;
        border-radius: 8px;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }

    .airline-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .trip-request-form {
        background: white;
        border-radius: 8px;
        padding: 0;
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10;
        width: calc(100% - 120px);
        max-width: 650px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .form-header {
        background: #0F2E6B;
        color: white;
        padding: 12px 20px;
        text-align: center;
    }

    .form-title {
        font-size: 16px;
        font-weight: 600;
        margin: 0;
    }

    .form-content {
        padding: 24px;
    }

    .trip-form-step {
        width: 100%;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-bottom: 16px;
    }

    .form-row-2col {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-bottom: 16px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .form-label {
        font-size: 12px;
        color: #374151;
        font-weight: 500;
        display: flex;
        align-items: center;
    }

    .form-select,
    .form-input {
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 13px;
        color: #1f2937;
        background: white;
    }

    .airport-select {
        font-weight: 600;
        font-size: 16px;
        color: #1f2937;
    }

    .form-select:focus,
    .form-input:focus {
        outline: none;
        border-color: #1e3a8a;
    }

    .form-actions {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-top: 20px;
    }

    .next-btn,
    .save-btn,
    .back-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 24px;
        background: white;
        border: 2px solid #1e3a8a;
        border-radius: 6px;
        color: #1e3a8a;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

        .next-btn:hover,
        .save-btn:hover,
        .back-btn:hover {
            background: #1e3a8a;
            color: white;
        }

    .save-btn,
    .back-btn {
        min-width: 120px;
        justify-content: center;
    }

        .back-btn svg {
            margin-left: -4px;
        }

    .back-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 24px;
        background: #f3f4f6;
        border: 2px solid #d1d5db;
        border-radius: 6px;
        color: #374151;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

        .back-btn:hover {
            background: #e2e8f0;
        }

    /* Booking History Section */
    .booking-history-section {
        background: #e2e8f0;
        padding: 20px 24px 60px 24px;
        margin-top: 0;
    }

    .history-header {
        background: #5f7a95;
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 8px 8px 0 0;
        margin-bottom: 0;
    }

    .aeroholder-brand {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .brand-name {
        font-size: 20px;
        font-weight: 700;
        color: white;
    }

    .brand-subtitle {
        font-size: 16px;
        color: white;
        font-weight: 400;
    }

    .search-box {
        position: relative;
    }

    .search-input {
        padding: 8px 40px 8px 16px;
        border: none;
        border-radius: 18px;
        font-size: 13px;
        width: 240px;
        background: white;
        transition: all 0.2s;
    }

        .search-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.4);
            width: 260px;
        }

        .search-input::placeholder {
            color: #9ca3af;
            font-size: 13px;
        }

    .search-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
    }

        .search-icon path {
            stroke: #9ca3af;
        }

    /* Table */
    .table-container {
        background: white;
        border-radius: 0 0 8px 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .booking-table {
        width: 100%;
        border-collapse: collapse;
    }

        .booking-table thead {
            background: white;
        }

        .booking-table th {
            padding: 12px 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 700;
            color: #1f2937;
            border-bottom: 2px solid #e5e7eb;
        }

        .booking-table td {
            padding: 10px 12px;
            font-size: 11px;
            color: #1f2937;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            line-height: 1.3;
        }

        .booking-table tbody tr {
            background: white;
            margin-bottom: 8px;
        }

            .booking-table tbody tr:hover {
                background: #f9fafb;
            }

    .row-number {
        font-weight: 700;
        color: #1f2937;
        font-size: 12px;
    }

    .route-dates {
        font-weight: 500;
        color: #1f2937;
        font-size: 11px;
    }

    .status-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
    }

    .status-issued,
    .status-approved {
        background: #86efac;
        color: #166534;
    }

    .status-pending {
        background: #e5e7eb;
        color: #4b5563;
    }

    .status-rejected {
        background: #fecaca;
        color: #991b1b;
    }

    .status-refunded {
        background: #fde68a;
        color: #92400e;
    }

    .text-center {
        text-align: center;
    }

    /* Pagination */
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 6px;
        margin-top: 20px;
    }

    .pagination-btn {
        padding: 6px 12px;
        border: 1px solid #d1d5db;
        background: white;
        border-radius: 4px;
        font-size: 12px;
        color: #374151;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 4px;
        font-weight: 500;
        min-width: 32px;
        justify-content: center;
    }

        .pagination-btn svg {
            width: 14px;
            height: 14px;
        }

        .pagination-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .pagination-btn.active {
            background: #1e3a8a;
            color: white;
            border-color: #1e3a8a;
            font-weight: 600;
        }

    .pagination-dots {
        padding: 0 4px;
        color: #6b7280;
        font-weight: 600;
        font-size: 12px;
    }
</style>

<script>
    // Global variable to store current trip request ID
    var currentTripRequestId = null;
    
    // Pagination variables
    var currentPage = 1;
    var recordsPerPage = 5;
    var allBookings = [];

    // Helper function to parse Microsoft JSON date format: /Date(milliseconds)/"
    function parseMicrosoftDate(dateString) {
        if (!dateString) return null;
        
        // Check if it's in Microsoft JSON date format
        var match = dateString.match(/\/Date\((\d+)\)\//);
        if (match) {
            return new Date(parseInt(match[1]));
        }
        
        // Otherwise try to parse as regular date string
        return new Date(dateString);
    }

    // Function to update itinerary details live
    function updateItineraryDetails() {
        // Get values from Trip Request Form (Form 1)
        var passengerName = document.getElementById('trip_fullName') ? document.getElementById('trip_fullName').value : '-';
        var ticketType = document.getElementById('trip_ticketType') ? document.getElementById('trip_ticketType').value : '-';
        var relationship = document.getElementById('trip_relationship') ? document.getElementById('trip_relationship').value : '-';
        var ticketIssue = document.getElementById('trip_ticketIssue') ? document.getElementById('trip_ticketIssue').value : '-';
        var entitlement = document.getElementById('trip_entitlement') ? document.getElementById('trip_entitlement').value : '-';
        
        // Get values from Manage Request Form (Form 2)
        var ticketNo = document.getElementById('manage_ticketNo') ? document.getElementById('manage_ticketNo').value : '-';
        var passport = document.getElementById('manage_passport') ? document.getElementById('manage_passport').value : '-';
        var departureAirport = document.getElementById('manage_departureAirport') ? document.getElementById('manage_departureAirport').value : '';
        var arrivalAirport = document.getElementById('manage_arrivalAirport') ? document.getElementById('manage_arrivalAirport').value : '';
        var departureDate = document.getElementById('manage_departureDate') ? document.getElementById('manage_departureDate').value : '';
        var departureTime = document.getElementById('manage_departureTime') ? document.getElementById('manage_departureTime').value : '';
        var returnDate = document.getElementById('manage_returnDate') ? document.getElementById('manage_returnDate').value : '';
        var returnTime = document.getElementById('manage_returnTime') ? document.getElementById('manage_returnTime').value : '';
        
        // Update itinerary details section
        if (document.getElementById('detail_passengerName')) document.getElementById('detail_passengerName').textContent = passengerName || '-';
        if (document.getElementById('detail_ticketType')) document.getElementById('detail_ticketType').textContent = ticketType || '-';
        if (document.getElementById('detail_relationship')) document.getElementById('detail_relationship').textContent = relationship || '-';
        if (document.getElementById('detail_ticketIssue')) document.getElementById('detail_ticketIssue').textContent = ticketIssue || '-';
        if (document.getElementById('detail_ticketNo')) document.getElementById('detail_ticketNo').textContent = ticketNo || '-';
        if (document.getElementById('detail_passport')) document.getElementById('detail_passport').textContent = passport || '-';
        if (document.getElementById('detail_entitlement')) document.getElementById('detail_entitlement').textContent = entitlement || '-';
        
        // Update route badge
        if (document.getElementById('detail_route')) {
            if (departureAirport && arrivalAirport) {
                document.getElementById('detail_route').innerHTML = departureAirport + ' <img src="/assets/smallplane.png" alt="to" style="width: 16px; height: 16px; vertical-align: middle; margin: 0 4px;"> ' + arrivalAirport;
            } else {
                document.getElementById('detail_route').textContent = '-';
            }
        }
        
        // Format and update departure date/time
        if (document.getElementById('detail_departure')) {
            if (departureDate) {
                var depDateTime = new Date(departureDate + (departureTime ? 'T' + departureTime : ''));
                var formattedDep = depDateTime.toLocaleDateString('en-US', { day: '2-digit', month: '2-digit', year: 'numeric' }) + (departureTime ? ' ' + departureTime : '');
                document.getElementById('detail_departure').textContent = formattedDep;
            } else {
                document.getElementById('detail_departure').textContent = '-';
            }
        }
        
        // Format and update return date/time
        if (document.getElementById('detail_return')) {
            if (returnDate) {
                var retDateTime = new Date(returnDate + (returnTime ? 'T' + returnTime : ''));
                var formattedRet = retDateTime.toLocaleDateString('en-US', { day: '2-digit', month: '2-digit', year: 'numeric' }) + (returnTime ? ' ' + returnTime : '');
                document.getElementById('detail_return').textContent = formattedRet;
            } else {
                document.getElementById('detail_return').textContent = '-';
            }
        }
    }

    // Function to attach event listeners to form fields
    function attachFormListeners() {
        var form1Fields = ['trip_fullName', 'trip_ticketType', 'trip_relationship', 'trip_ticketIssue', 'trip_entitlement'];
        var form2Fields = ['manage_ticketNo', 'manage_passport', 'manage_departureAirport', 'manage_arrivalAirport', 'manage_departureDate', 'manage_departureTime', 'manage_returnDate', 'manage_returnTime'];
        
        form1Fields.concat(form2Fields).forEach(function(fieldId) {
            var field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('input', updateItineraryDetails);
                field.addEventListener('change', updateItineraryDetails);
            }
        });
    }

    function openItineraryModal(folioId, shareholderName) {
        document.getElementById('itinerary_shareholderName').value = shareholderName || '';
        document.getElementById('itinerary_folioId').value = folioId || '';
        document.getElementById('trip_fullName').value = shareholderName || '';
        
        document.getElementById('tripRequestForm1').style.display = 'block';
        document.getElementById('tripRequestForm2').style.display = 'none';
        currentTripRequestId = null;
        currentPage = 1;
        
        updateItineraryDetails();
        loadBookingHistory(folioId);
        loadPassportsForDropdown(folioId);
        
        document.getElementById('itineraryModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function loadPassportsForDropdown(folioId) {
        var passportSelect = document.getElementById('manage_passport');
        if (!passportSelect) return;
        
        passportSelect.innerHTML = '<option value="">-- Select Passport --</option>';
        
        if (!folioId) return;
        
        fetch('/Itinerary/GetPassportsByFolioId?folioId=' + encodeURIComponent(folioId))
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success && data.data && data.data.length > 0) {
                    data.data.forEach(function(passport) {
                        var option = document.createElement('option');
                        option.value = passport.PassportNumber;
                        option.textContent = passport.PassportNumber + (passport.IssuedCountry ? ' (' + passport.IssuedCountry + ')' : '');
                        passportSelect.appendChild(option);
                    });
                    if (data.data.length > 0) {
                        passportSelect.value = data.data[0].PassportNumber;
                        updateItineraryDetails();
                    }
                } else {
                    var noPassportOption = document.createElement('option');
                    noPassportOption.value = '';
                    noPassportOption.textContent = 'No passports available';
                    noPassportOption.disabled = true;
                    passportSelect.appendChild(noPassportOption);
                }
            })
            .catch(function(error) {
                console.error('Error loading passports:', error);
            });
    }

    function closeItineraryModal() {
        document.getElementById('itineraryModal').style.display = 'none';
        document.body.style.overflow = 'auto';
        document.getElementById('tripRequestForm1').style.display = 'block';
        document.getElementById('tripRequestForm2').style.display = 'none';
        currentTripRequestId = null;
    }

    function showManageRequestForm() {
        var folioId = document.getElementById('itinerary_folioId').value;
        var fullName = document.getElementById('trip_fullName').value;
        var ticketType = document.getElementById('trip_ticketType').value;
        var relationship = document.getElementById('trip_relationship').value;
        var remarks = document.getElementById('trip_remarks').value;
        var ticketIssue = parseInt(document.getElementById('trip_ticketIssue').value) || 1;
        var entitlement = document.getElementById('trip_entitlement').value;

        if (!fullName || !ticketType) {
            alert('Please fill in all required fields');
            return;
        }

        var formData = {
            FolioID: folioId,
            FullName: fullName,
            TicketType: ticketType,
            Relationship: relationship,
            Remarks: remarks,
            TicketIssue: ticketIssue,
            Entitlement: entitlement
        };

        var nextBtn = document.querySelector('.next-btn');
        var originalText = nextBtn.innerHTML;
        nextBtn.innerHTML = 'Saving...';
        nextBtn.disabled = true;

        fetch('/Itinerary/SubmitTripRequest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            nextBtn.innerHTML = originalText;
            nextBtn.disabled = false;
            if (data.success) {
                currentTripRequestId = data.tripRequestId;
                document.getElementById('tripRequestForm1').style.display = 'none';
                document.getElementById('tripRequestForm2').style.display = 'block';
                updateItineraryDetails();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(function(error) {
            nextBtn.innerHTML = originalText;
            nextBtn.disabled = false;
            alert('Failed to submit trip request.');
        });
    }

    function showTripRequestForm() {
        document.getElementById('tripRequestForm2').style.display = 'none';
        document.getElementById('tripRequestForm1').style.display = 'block';
        updateItineraryDetails();
    }

    function saveTripRequest() {
        if (!currentTripRequestId) {
            alert('Please complete Form 1 first');
            return;
        }

        var ticketNo = document.getElementById('manage_ticketNo').value;
        var passportNumber = document.getElementById('manage_passport').value;
        var departureAirport = document.getElementById('manage_departureAirport').value;
        var departureCity = document.getElementById('manage_departureAirport').selectedOptions[0] ? document.getElementById('manage_departureAirport').selectedOptions[0].getAttribute('data-city') : '';
        var arrivalAirport = document.getElementById('manage_arrivalAirport').value;
        var arrivalCity = document.getElementById('manage_arrivalAirport').selectedOptions[0] ? document.getElementById('manage_arrivalAirport').selectedOptions[0].getAttribute('data-city') : '';
        var departureDate = document.getElementById('manage_departureDate').value;
        var departureTime = document.getElementById('manage_departureTime').value || '00:00';
        var departureDateTimeString = departureDate && departureTime ? departureDate + 'T' + departureTime + ':00' : departureDate;
        var returnDate = document.getElementById('manage_returnDate').value;
        var returnTime = document.getElementById('manage_returnTime').value || '00:00';
        var returnDateTimeString = returnDate && returnTime ? returnDate + 'T' + returnTime + ':00' : returnDate;

        var formData = {
            TripRequestID: currentTripRequestId,
            TicketNo: ticketNo,
            PassportNumber: passportNumber,
            DepartureAirport: departureAirport,
            DepartureCity: departureCity,
            ArrivalAirport: arrivalAirport,
            ArrivalCity: arrivalCity,
            DepartureDate: departureDateTimeString,
            ReturnDate: returnDateTimeString
        };

        var saveBtn = document.querySelector('.save-btn');
        var originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = 'Saving...';
        saveBtn.disabled = true;

        fetch('/Itinerary/SubmitManageRequest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
            if (data.success) {
                alert('Trip request saved successfully!');
                var folioId = document.getElementById('itinerary_folioId').value;
                loadBookingHistory(folioId);
                closeItineraryModal();
                window.location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(function(error) {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
            alert('Failed to save trip request.');
        });
    }

    function loadBookingHistory(folioId) {
        if (!folioId) return;
        currentPage = 1;

        fetch('/Itinerary/GetBookingHistory?folioId=' + encodeURIComponent(folioId))
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success && data.data) {
                    allBookings = data.data;
                    renderBookingHistoryPage();
                }
            })
            .catch(function(error) {
                console.error('Error loading booking history:', error);
            });
    }

    function renderBookingHistoryPage() {
        var tbody = document.getElementById('bookingHistoryTableBody');
        if (!tbody) return;

        if (!allBookings || allBookings.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px; color: #6b7280;">No booking history found.</td></tr>';
            renderPagination(0, 0);
            return;
        }

        var totalRecords = allBookings.length;
        var totalPages = Math.ceil(totalRecords / recordsPerPage);
        currentPage = Math.max(1, Math.min(currentPage, totalPages));

        var startIdx = (currentPage - 1) * recordsPerPage;
        var endIdx = Math.min(startIdx + recordsPerPage, totalRecords);
        var pageBookings = allBookings.slice(startIdx, endIdx);

        var html = '';
        for (var i = 0; i < pageBookings.length; i++) {
            var booking = pageBookings[i];
            var globalRowNum = startIdx + i + 1;

            var formattedDate = '-', formattedTime = '-';
            if (booking.UpdatedDate) {
                try {
                    var updatedDate = parseMicrosoftDate(booking.UpdatedDate);
                    if (updatedDate && !isNaN(updatedDate.getTime())) {
                        formattedDate = updatedDate.toISOString().split('T')[0];
                        formattedTime = updatedDate.toTimeString().split(' ')[0];
                    }
                } catch (e) {}
            }

            var depDate = '-';
            if (booking.DepartureDate) {
                try {
                    var date = parseMicrosoftDate(booking.DepartureDate);
                    if (date && !isNaN(date.getTime())) {
                        depDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    }
                } catch (e) {}
            }

            var retDate = '-';
            if (booking.ReturnDate) {
                try {
                    var date = parseMicrosoftDate(booking.ReturnDate);
                    if (date && !isNaN(date.getTime())) {
                        retDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    }
                } catch (e) {}
            }

            var bookingDate = '-';
            if (booking.BookingDate) {
                try {
                    var date = parseMicrosoftDate(booking.BookingDate);
                    if (date && !isNaN(date.getTime())) {
                        bookingDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    }
                } catch (e) {}
            }

            // Determine status class based on status value
            var status = (booking.Status || 'Pending').toLowerCase();
            var statusClass = 'status-pending';
            if (status === 'issued') statusClass = 'status-issued';
            else if (status === 'approved') statusClass = 'status-approved';
            else if (status === 'rejected') statusClass = 'status-rejected';
            else if (status === 'refunded') statusClass = 'status-refunded';
            else if (status === 'pending') statusClass = 'status-pending';

            html += '<tr>' +
                '<td class="row-number">' + globalRowNum + '.</td>' +
                '<td>' + formattedDate + '<br/>' + formattedTime + '</td>' +
                '<td><span class="route-dates">' + depDate + '<br/><img src="/assets/arrowIcon.png" alt="to" style="width: 12px; height: 12px; vertical-align: middle; margin: 0 4px;"> ' + retDate + '</span></td>' +
                '<td>' + (booking.DepartureAirport || '-') + ' <img src="/assets/takeoff.png" alt="takeoff" style="width: 14px; height: 14px; vertical-align: middle; margin: 0 2px;"> ' + (booking.ArrivalAirport || '-') + '</td>' +
                '<td>' + bookingDate + '</td>' +
                '<td><span class="status-badge ' + statusClass + '">' + (booking.Status || 'Pending') + '</span></td>' +
                '<td>' + (booking.UpdatedBy || '-') + '</td>' +
                '<td>' + (booking.PassengerName || '-') + '</td>' +
                '<td class="text-center">1</td>' +
                '<td>' + (booking.TicketType || '-') + '</td>' +
                '</tr>';
        }

        tbody.innerHTML = html;
        renderPagination(totalRecords, totalPages);
    }

    function renderPagination(totalRecords, totalPages) {
        var container = document.querySelector('.booking-history-section .pagination');
        if (!container) return;

        if (totalRecords === 0 || totalPages <= 1) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'flex';
        container.innerHTML = '';

        // Prev button
        var prevBtn = document.createElement('button');
        prevBtn.className = 'pagination-btn' + (currentPage === 1 ? ' disabled' : '');
        prevBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" /></svg> Prev';
        if (currentPage > 1) {
            prevBtn.onclick = function() { currentPage--; renderBookingHistoryPage(); };
        } else {
            prevBtn.style.opacity = '0.5';
            prevBtn.style.cursor = 'not-allowed';
        }
        container.appendChild(prevBtn);

        // Page buttons
        for (var i = 1; i <= totalPages; i++) {
            (function(pageNum) {
                var pageBtn = document.createElement('button');
                pageBtn.className = 'pagination-btn' + (pageNum === currentPage ? ' active' : '');
                pageBtn.textContent = pageNum;
                pageBtn.onclick = function() { currentPage = pageNum; renderBookingHistoryPage(); };
                container.appendChild(pageBtn);
            })(i);
        }

        // Next button
        var nextBtn = document.createElement('button');
        nextBtn.className = 'pagination-btn' + (currentPage === totalPages ? ' disabled' : '');
        nextBtn.innerHTML = 'Next <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" /></svg>';
        if (currentPage < totalPages) {
            nextBtn.onclick = function() { currentPage++; renderBookingHistoryPage(); };
        } else {
            nextBtn.style.opacity = '0.5';
            nextBtn.style.cursor = 'not-allowed';
        }
        container.appendChild(nextBtn);
    }

    // For backward compatibility
    function displayBookingHistory(bookings) {
        allBookings = bookings || [];
        currentPage = 1;
        renderBookingHistoryPage();
    }

    // Search booking history
    document.addEventListener('DOMContentLoaded', function() {
        attachFormListeners();
        
        var searchInput = document.querySelector('.booking-history-section .search-input');
        if (searchInput) {
            var searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                var self = this;
                searchTimeout = setTimeout(function() {
                    var searchTerm = self.value.trim();
                    var folioId = document.getElementById('itinerary_folioId') ? document.getElementById('itinerary_folioId').value : '';
                    
                    if (folioId) {
                        currentPage = 1;
                        if (searchTerm) {
                            fetch('/Itinerary/SearchBookingHistory?folioId=' + encodeURIComponent(folioId) + '&searchTerm=' + encodeURIComponent(searchTerm))
                                .then(function(response) { return response.json(); })
                                .then(function(data) {
                                    if (data.success && data.data) {
                                        allBookings = data.data;
                                        renderBookingHistoryPage();
                                    }
                                })
                                .catch(function(error) { console.error('Search error:', error); });
                        } else {
                            loadBookingHistory(folioId);
                        }
                    }
                }, 300);
            });
        }
    });

    // Close on Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && document.getElementById('itineraryModal').style.display === 'flex') {
            closeItineraryModal();
        }
    });

    // Close on overlay click
    document.addEventListener('click', function(event) {
        var modal = document.getElementById('itineraryModal');
        if (event.target === modal) {
            closeItineraryModal();
        }
    });
</script>
