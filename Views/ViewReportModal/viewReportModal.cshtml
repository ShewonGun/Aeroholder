@* View Report Modal *@
<div class="modal-overlay" id="viewReportModal" style="display: none;">
    <div class="report-modal-dialog">
        <div class="report-modal-content">
            <div class="report-header">
                <h1 class="header-title">Summary Report</h1>
                <button class="close-btn" onclick="closeReportModal()">✕</button>
            </div>
            <div class="report-modal-body">
                <div class="shareholder-info">
                    <div class="info-group">
                        <label class="info-label">Shareholder Name</label>
                        <input type="text" class="info-input" id="report_shareholderName" readonly>
                    </div>
                    <div class="info-group">
                        <label class="info-label">Folion ID</label>
                        <input type="text" class="info-input folio-id" id="report_folioId" readonly>
                    </div>
                </div>
                <div class="itinerary-card">
                    <div class="issued-badge" id="report_statusBadge">Pending</div>
                    <div class="card-header">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M20 7H4C2.89543 7 2 7.89543 2 9V19C2 20.1046 2.89543 21 4 21H20C21.1046 21 22 20.1046 22 19V9C22 7.89543 21.1046 7 20 7Z" stroke="white" stroke-width="2" />
                            <path d="M16 21V5C16 4.46957 15.7893 3.96086 15.4142 3.58579C15.0391 3.21071 14.5304 3 14 3H10C9.46957 3 8.96086 3.21071 8.58579 3.58579C8.21071 3.96086 8 4.46957 8 5V21" stroke="white" stroke-width="2" />
                        </svg>
                        <h2 class="card-title">Report Details</h2>
                    </div>
                    <div class="itinerary-content">
                        <div class="route-section">
                            <div class="route-badge"><span class="route-text" id="report_route">-</span></div>
                        </div>
                        <div class="details-table">
                            <div class="details-row">
                                <div class="details-cell"><div class="cell-label">Passenger Name</div><div class="cell-value" id="report_passengerName">-</div></div>
                                <div class="details-cell"><div class="cell-label">Ticket Type</div><div class="cell-value" id="report_ticketType">-</div></div>
                                <div class="details-cell"><div class="cell-label">Relationship</div><div class="cell-value" id="report_relationship">-</div></div>
                                <div class="details-cell"><div class="cell-label">Ticket Issue</div><div class="cell-value" id="report_ticketIssue">-</div></div>
                            </div>
                            <div class="details-row">
                                <div class="details-cell"><div class="cell-label">Ticket No</div><div class="cell-value" id="report_ticketNo">-</div></div>
                                <div class="details-cell"><div class="cell-label">Passport</div><div class="cell-value" id="report_passport">-</div></div>
                                <div class="details-cell"><div class="cell-label">Departure</div><div class="cell-value" id="report_departure">-</div></div>
                                <div class="details-cell"><div class="cell-label">Return</div><div class="cell-value" id="report_return">-</div></div>
                                <div class="details-cell"><div class="cell-label">Entitlement</div><div class="cell-value" id="report_entitlement">-</div></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="report-filter-section">
                    <div class="airline-image-container"><img src="~/assets/ItineraryImage.png" alt="SriLankan Airlines" class="airline-image"></div>
                    <div class="report-filter-form">
                        <div class="filter-form-content">
                            <div class="filter-row filter-row-4">
                                <div class="filter-group"><label class="filter-label">Folion ID</label><input type="text" class="filter-input" id="filter_folioId" readonly></div>
                                <div class="filter-group"><label class="filter-label">Name</label><input type="text" class="filter-input" id="filter_name" readonly></div>
                                <div class="filter-group"><label class="filter-label">From</label><input type="date" class="filter-input" id="filter_fromDate" readonly></div>
                                <div class="filter-group"><label class="filter-label">To</label><input type="date" class="filter-input" id="filter_toDate" readonly></div>
                            </div>
                            <div class="filter-row filter-row-4">
                                <div class="filter-group"><label class="filter-label">Origin <img src="~/assets/takeoff.png" alt="takeoff" class="label-icon"></label><input type="text" class="filter-input" id="filter_origin" readonly></div>
                                <div class="filter-group"><label class="filter-label">Destination <img src="~/assets/landing.png" alt="landing" class="label-icon"></label><input type="text" class="filter-input" id="filter_destination" readonly></div>
                                <div class="filter-group"><label class="filter-label">Entity Type</label><select class="filter-select" id="filter_entityType"><option value="">All</option><option value="Shareholder">Shareholder</option><option value="Dependent">Dependent</option><option value="Spouse">Spouse</option></select></div>
                                <div class="filter-group"><label class="filter-label">Request Status</label><select class="filter-select" id="filter_status"><option value="">All</option><option value="Pending">Pending</option><option value="Issued">Issued</option><option value="Approved">Approved</option><option value="Rejected">Rejected</option><option value="Refunded">Refunded</option></select></div>
                            </div>
                            <div class="stats-row">
                                <div class="stat-box"><span class="stat-label">Total Issued:</span><span class="stat-value" id="stat_totalIssued">0</span></div>
                                <div class="stat-box"><span class="stat-label">Total Refunded:</span><span class="stat-value" id="stat_totalRefunded">0</span></div>
                                <div class="stat-box"><span class="stat-label">Total Rejected:</span><span class="stat-value" id="stat_totalRejected">0</span></div>
                                <div class="stat-box stat-box-highlight"><span class="stat-label">Total Flights:</span><span class="stat-value" id="stat_totalFlights">0</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="booking-history-section">
                    <div class="history-header">
                        <div class="aeroholder-brand"><img src="~/assets/smallplane.png" alt="plane" style="width: 16px; height: 16px; vertical-align: middle; margin: 0 4px;"><span class="brand-name">AeroHolder</span><span class="brand-subtitle">Booking History</span></div>
                        <div class="search-box"><input type="text" class="search-input" id="report_searchInput" placeholder=""><svg class="search-icon" width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M9 17C13.4183 17 17 13.4183 17 9C17 4.58172 13.4183 1 9 1C4.58172 1 1 4.58172 1 9C1 13.4183 4.58172 17 9 17Z" stroke="#6b7280" stroke-width="2" /><path d="M19 19L14.65 14.65" stroke="#6b7280" stroke-width="2" /></svg></div>
                    </div>
                    <div class="table-container">
                        <table class="booking-table">
                            <thead><tr><th style="width: 40px;"></th><th>Updated-on</th><th>From - To</th><th>Travel Route</th><th>Date</th><th>Status</th><th>Updated-by</th><th>Passenger</th><th style="text-align: center;">Tickets</th><th>Type</th></tr></thead>
                            <tbody id="reportBookingHistoryTableBody"><tr><td colspan="10" style="text-align: center; padding: 20px; color: #6b7280;">No booking history found.</td></tr></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="reportPagination"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .modal-overlay#viewReportModal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.4); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .report-modal-dialog { max-width: 900px; width: 100%; max-height: 95vh; display: flex; flex-direction: column; }
    .report-modal-content { background: white; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; max-height: 95vh; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); }
    .report-modal-body { overflow-y: auto; background: #e8eaf0; flex: 1; scrollbar-width: none; -ms-overflow-style: none; }
    .report-modal-body::-webkit-scrollbar { display: none; }
    .report-header { background: #0F2E6B; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
    .report-header .header-title { color: white; font-size: 16px; font-weight: 600; margin: 0; }
    .report-header .close-btn { background: transparent; border: none; color: white; font-size: 22px; cursor: pointer; }
    .itinerary-card .issued-badge { position: absolute; top: -12px; left: 24px; background: #9ca3af; color: white; padding: 6px 16px; border-radius: 4px; font-size: 12px; font-weight: 600; z-index: 10; }
    .itinerary-card .issued-badge.status-pending { background: #9ca3af; }
    .itinerary-card .issued-badge.status-issued, .itinerary-card .issued-badge.status-approved { background: #10b981; }
    .itinerary-card .issued-badge.status-rejected { background: #ef4444; }
    .itinerary-card .issued-badge.status-refunded { background: #f59e0b; }
    .report-filter-section { margin: 0 24px 16px 24px; position: relative; height: 420px; }
    .report-filter-section .airline-image-container { width: 100%; height: 100%; overflow: hidden; border-radius: 8px; position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
    .report-filter-section .airline-image { width: 100%; height: 100%; object-fit: cover; }
    .report-filter-form { background: white; border-radius: 8px; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 10; width: calc(100% - 60px); max-width: 780px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
    .filter-form-content { padding: 20px 24px; }
    .filter-row { display: grid; gap: 16px; margin-bottom: 16px; }
    .filter-row-4 { grid-template-columns: repeat(4, 1fr); }
    .filter-group { display: flex; flex-direction: column; gap: 6px; }
    .filter-label { font-size: 12px; color: #374151; font-weight: 500; display: flex; align-items: center; gap: 6px; }
    .label-icon { width: 14px; height: 14px; }
    .filter-input, .filter-select { padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; }
    .filter-input[readonly] { background: #f9fafb; color: #6b7280; }
    .stats-row { display: flex; gap: 12px; margin-top: 8px; justify-content: center; }
    .stat-box { display: flex; align-items: center; gap: 6px; padding: 10px 20px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 6px; }
    .stat-box-highlight { background: #e0e7ff; border-color: #c7d2fe; }
    .stat-label { font-size: 13px; color: #374151; font-weight: 500; }
    .stat-value { font-size: 14px; color: #1e3a8a; font-weight: 700; }
    .status-dropdown { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; border: none; cursor: pointer; }
    .status-dropdown.status-pending { background: #e5e7eb; color: #4b5563; }
    .status-dropdown.status-issued { background: #86efac; color: #166534; }
    .status-dropdown.status-rejected { background: #fecaca; color: #991b1b; }
    .status-dropdown.status-refunded { background: #fde68a; color: #92400e; }
</style>

<script>
    var reportCurrentPage = 1;
    var reportRecordsPerPage = 5;
    var reportAllBookings = [];

    function openReportModal(folioId, shareholderName) {
        document.getElementById('report_shareholderName').value = shareholderName || '';
        document.getElementById('report_folioId').value = folioId || '';
        document.getElementById('filter_folioId').value = folioId || '';
        document.getElementById('filter_name').value = shareholderName || '';
        reportCurrentPage = 1;
        loadReportBookingHistory(folioId);
        document.getElementById('viewReportModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeReportModal() {
        document.getElementById('viewReportModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function loadReportBookingHistory(folioId) {
        if (!folioId) return;
        fetch('/Itinerary/GetBookingHistory?folioId=' + encodeURIComponent(folioId))
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success && data.data) {
                    reportAllBookings = data.data;
                    calculateReportStatistics();
                    renderReportBookingHistoryPage();
                    updateReportDetailsFromLatest();
                    updateReportStatusBadge();
                }
            })
            .catch(function(e) { console.error('Error:', e); });
    }

    function updateReportStatusBadge() {
        var badge = document.getElementById('report_statusBadge');
        if (!badge) return;
        badge.className = 'issued-badge';
        if (!reportAllBookings || reportAllBookings.length === 0) { badge.textContent = 'Pending'; badge.classList.add('status-pending'); return; }
        var status = (reportAllBookings[0].Status || 'Pending').toLowerCase();
        if (status === 'issued') { badge.textContent = 'Issued'; badge.classList.add('status-issued'); }
        else if (status === 'approved') { badge.textContent = 'Approved'; badge.classList.add('status-approved'); }
        else if (status === 'rejected') { badge.textContent = 'Rejected'; badge.classList.add('status-rejected'); }
        else if (status === 'refunded') { badge.textContent = 'Refunded'; badge.classList.add('status-refunded'); }
        else { badge.textContent = 'Pending'; badge.classList.add('status-pending'); }
    }

    function calculateReportStatistics() {
        var totalIssued = 0, totalRefunded = 0, totalRejected = 0;
        for (var i = 0; i < reportAllBookings.length; i++) {
            var s = (reportAllBookings[i].Status || '').toLowerCase();
            if (s === 'issued' || s === 'approved') totalIssued++;
            else if (s === 'refunded') totalRefunded++;
            else if (s === 'rejected') totalRejected++;
        }
        document.getElementById('stat_totalIssued').textContent = totalIssued;
        document.getElementById('stat_totalRefunded').textContent = totalRefunded;
        document.getElementById('stat_totalRejected').textContent = totalRejected;
        document.getElementById('stat_totalFlights').textContent = reportAllBookings.length;
    }

    function updateReportDetailsFromLatest() {
        var fields = ['report_passengerName', 'report_ticketType', 'report_relationship', 'report_ticketIssue', 'report_ticketNo', 'report_passport', 'report_entitlement', 'report_route', 'report_departure', 'report_return'];
        if (reportAllBookings.length === 0) {
            for (var i = 0; i < fields.length; i++) { var el = document.getElementById(fields[i]); if (el) el.textContent = '-'; }
            document.getElementById('filter_fromDate').value = '';
            document.getElementById('filter_toDate').value = '';
            document.getElementById('filter_origin').value = '';
            document.getElementById('filter_destination').value = '';
            return;
        }
        var b = reportAllBookings[0];
        document.getElementById('report_passengerName').textContent = b.PassengerName || '-';
        document.getElementById('report_ticketType').textContent = b.TicketType || '-';
        document.getElementById('report_relationship').textContent = b.Relationship || '-';
        document.getElementById('report_ticketIssue').textContent = b.TicketIssue || '-';
        document.getElementById('report_ticketNo').textContent = b.TicketNo || '-';
        document.getElementById('report_passport').textContent = b.PassportNumber || '-';
        document.getElementById('report_entitlement').textContent = b.Entitlement || '-';
        document.getElementById('report_route').innerHTML = (b.DepartureAirport && b.ArrivalAirport) ? b.DepartureAirport + ' <img src="/assets/smallplane.png" style="width:16px;height:16px;vertical-align:middle;margin:0 4px"> ' + b.ArrivalAirport : '-';
        if (b.DepartureDate) { var d = parseReportDate(b.DepartureDate); if (d) { document.getElementById('report_departure').textContent = d.toLocaleDateString(); document.getElementById('filter_fromDate').value = d.toISOString().split('T')[0]; } }
        else { document.getElementById('report_departure').textContent = '-'; document.getElementById('filter_fromDate').value = ''; }
        if (b.ReturnDate) { var d = parseReportDate(b.ReturnDate); if (d) { document.getElementById('report_return').textContent = d.toLocaleDateString(); document.getElementById('filter_toDate').value = d.toISOString().split('T')[0]; } }
        else { document.getElementById('report_return').textContent = '-'; document.getElementById('filter_toDate').value = ''; }
        document.getElementById('filter_origin').value = b.DepartureAirport || '';
        document.getElementById('filter_destination').value = b.ArrivalAirport || '';
    }

    function parseReportDate(ds) { if (!ds) return null; var m = ds.match(/\/Date\((\d+)\)\//); return m ? new Date(parseInt(m[1])) : new Date(ds); }

    function renderReportBookingHistoryPage() {
        var tbody = document.getElementById('reportBookingHistoryTableBody');
        if (!tbody) return;
        if (!reportAllBookings || reportAllBookings.length === 0) { tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:20px;color:#6b7280;">No booking history found.</td></tr>'; return; }
        var total = reportAllBookings.length, pages = Math.ceil(total / reportRecordsPerPage);
        reportCurrentPage = Math.max(1, Math.min(reportCurrentPage, pages));
        var start = (reportCurrentPage - 1) * reportRecordsPerPage, end = Math.min(start + reportRecordsPerPage, total);
        var html = '';
        for (var i = start; i < end; i++) {
            var b = reportAllBookings[i], row = i + 1;
            var fd = '-', ft = '-'; if (b.UpdatedDate) { var d = parseReportDate(b.UpdatedDate); if (d) { fd = d.toISOString().split('T')[0]; ft = d.toTimeString().split(' ')[0]; } }
            var dep = '-', ret = '-', bd = '-';
            if (b.DepartureDate) { var d = parseReportDate(b.DepartureDate); if (d) dep = d.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}); }
            if (b.ReturnDate) { var d = parseReportDate(b.ReturnDate); if (d) ret = d.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}); }
            if (b.BookingDate) { var d = parseReportDate(b.BookingDate); if (d) bd = d.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}); }
            var st = (b.Status || 'Pending').toLowerCase(), sc = 'status-pending';
            if (st === 'issued' || st === 'approved') sc = 'status-issued';
            else if (st === 'rejected') sc = 'status-rejected';
            else if (st === 'refunded') sc = 'status-refunded';
            var dd = '<select class="status-dropdown '+sc+'" onchange="updateBookingStatus('+b.BookingID+',this.value)">' +
                '<option value="Pending"'+(st==='pending'?' selected':'')+'>Pending</option>' +
                '<option value="Issued"'+(st==='issued'?' selected':'')+'>Issued</option>' +
                '<option value="Approved"'+(st==='approved'?' selected':'')+'>Approved</option>' +
                '<option value="Rejected"'+(st==='rejected'?' selected':'')+'>Rejected</option>' +
                '<option value="Refunded"'+(st==='refunded'?' selected':'')+'>Refunded</option></select>';
            html += '<tr><td class="row-number">'+row+'.</td><td>'+fd+'<br/>'+ft+'</td><td><span class="route-dates">'+dep+'<br/><img src="/assets/arrowIcon.png" style="width:12px;height:12px;vertical-align:middle;margin:0 4px">'+ret+'</span></td><td>'+(b.DepartureAirport||'-')+' <img src="/assets/takeoff.png" style="width:14px;height:14px;vertical-align:middle;margin:0 2px"> '+(b.ArrivalAirport||'-')+'</td><td>'+bd+'</td><td>'+dd+'</td><td>'+(b.UpdatedBy||'-')+'</td><td>'+(b.PassengerName||'-')+'</td><td class="text-center">1</td><td>'+(b.TicketType||'-')+'</td></tr>';
        }
        tbody.innerHTML = html;
        renderReportPagination(total, pages);
    }

    function renderReportPagination(total, pages) {
        var c = document.getElementById('reportPagination');
        if (!c) return;
        if (total === 0 || pages <= 1) { c.style.display = 'none'; return; }
        c.style.display = 'flex'; c.innerHTML = '';
        var prev = document.createElement('button'); prev.className = 'pagination-btn'; prev.textContent = 'Prev';
        if (reportCurrentPage > 1) { prev.onclick = function() { reportCurrentPage--; renderReportBookingHistoryPage(); }; } else { prev.style.opacity = '0.5'; prev.style.cursor = 'not-allowed'; }
        c.appendChild(prev);
        for (var i = 1; i <= pages; i++) { (function(p) { var btn = document.createElement('button'); btn.className = 'pagination-btn'+(p===reportCurrentPage?' active':''); btn.textContent = p; btn.onclick = function() { reportCurrentPage = p; renderReportBookingHistoryPage(); }; c.appendChild(btn); })(i); }
        var next = document.createElement('button'); next.className = 'pagination-btn'; next.textContent = 'Next';
        if (reportCurrentPage < pages) { next.onclick = function() { reportCurrentPage++; renderReportBookingHistoryPage(); }; } else { next.style.opacity = '0.5'; next.style.cursor = 'not-allowed'; }
        c.appendChild(next);
    }

    function updateBookingStatus(bookingId, newStatus) {
        if (!bookingId || !newStatus) return;
        fetch('/Itinerary/UpdateBookingStatus', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: 'bookingId=' + encodeURIComponent(bookingId) + '&status=' + encodeURIComponent(newStatus) })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                for (var i = 0; i < reportAllBookings.length; i++) { if (reportAllBookings[i].BookingID === bookingId) { reportAllBookings[i].Status = newStatus; break; } }
                calculateReportStatistics(); renderReportBookingHistoryPage(); updateReportDetailsFromLatest(); updateReportStatusBadge();
            } else { alert('Failed: ' + data.message); }
        })
        .catch(function(e) { alert('Error updating status.'); });
    }

    function applyReportFilters() {
        var et = document.getElementById('filter_entityType').value;
        var st = document.getElementById('filter_status').value;
        var sr = document.getElementById('report_searchInput').value.toLowerCase();
        var filtered = [];
        for (var i = 0; i < reportAllBookings.length; i++) {
            var b = reportAllBookings[i], match = true;
            if (et && b.TicketType && b.TicketType.toLowerCase() !== et.toLowerCase()) match = false;
            if (st && b.Status && b.Status.toLowerCase() !== st.toLowerCase()) match = false;
            if (sr && !((b.PassengerName||'').toLowerCase().indexOf(sr)>=0 || (b.TicketNo||'').toLowerCase().indexOf(sr)>=0 || (b.DepartureAirport||'').toLowerCase().indexOf(sr)>=0 || (b.ArrivalAirport||'').toLowerCase().indexOf(sr)>=0)) match = false;
            if (match) filtered.push(b);
        }
        var ti = 0, tr = 0, tj = 0;
        for (var i = 0; i < filtered.length; i++) { var s = (filtered[i].Status||'').toLowerCase(); if (s==='issued'||s==='approved') ti++; else if (s==='refunded') tr++; else if (s==='rejected') tj++; }
        document.getElementById('stat_totalIssued').textContent = ti;
        document.getElementById('stat_totalRefunded').textContent = tr;
        document.getElementById('stat_totalRejected').textContent = tj;
        document.getElementById('stat_totalFlights').textContent = filtered.length;
        reportCurrentPage = 1;
        renderFilteredBookings(filtered);
    }

    function renderFilteredBookings(fb) {
        var tbody = document.getElementById('reportBookingHistoryTableBody');
        if (!fb || fb.length === 0) { tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:20px;color:#6b7280;">No results found.</td></tr>'; document.getElementById('reportPagination').style.display = 'none'; return; }
        var total = fb.length, pages = Math.ceil(total / reportRecordsPerPage);
        var start = (reportCurrentPage - 1) * reportRecordsPerPage, end = Math.min(start + reportRecordsPerPage, total);
        var html = '';
        for (var i = start; i < end; i++) {
            var b = fb[i], row = i + 1;
            var fd = '-', ft = '-'; if (b.UpdatedDate) { var d = parseReportDate(b.UpdatedDate); if (d) { fd = d.toISOString().split('T')[0]; ft = d.toTimeString().split(' ')[0]; } }
            var dep = '-', ret = '-', bd = '-';
            if (b.DepartureDate) { var d = parseReportDate(b.DepartureDate); if (d) dep = d.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}); }
            if (b.ReturnDate) { var d = parseReportDate(b.ReturnDate); if (d) ret = d.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}); }
            if (b.BookingDate) { var d = parseReportDate(b.BookingDate); if (d) bd = d.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}); }
            var st = (b.Status || 'Pending').toLowerCase(), sc = 'status-pending';
            if (st === 'issued' || st === 'approved') sc = 'status-issued';
            else if (st === 'rejected') sc = 'status-rejected';
            else if (st === 'refunded') sc = 'status-refunded';
            var dd = '<select class="status-dropdown '+sc+'" onchange="updateBookingStatus('+b.BookingID+',this.value)"><option value="Pending"'+(st==='pending'?' selected':'')+'>Pending</option><option value="Issued"'+(st==='issued'?' selected':'')+'>Issued</option><option value="Approved"'+(st==='approved'?' selected':'')+'>Approved</option><option value="Rejected"'+(st==='rejected'?' selected':'')+'>Rejected</option><option value="Refunded"'+(st==='refunded'?' selected':'')+'>Refunded</option></select>';
            html += '<tr><td class="row-number">'+row+'.</td><td>'+fd+'<br/>'+ft+'</td><td><span class="route-dates">'+dep+'<br/><img src="/assets/arrowIcon.png" style="width:12px;height:12px;vertical-align:middle;margin:0 4px">'+ret+'</span></td><td>'+(b.DepartureAirport||'-')+' <img src="/assets/takeoff.png" style="width:14px;height:14px;vertical-align:middle;margin:0 2px"> <img src="/assets/landing.png" style="width:14px;height:14px;vertical-align:middle;margin:0 2px"> '+(b.ArrivalAirport||'-')+'</td><td>'+bd+'</td><td>'+dd+'</td><td>'+(b.UpdatedBy||'-')+'</td><td>'+(b.PassengerName||'-')+'</td><td class="text-center">1</td><td>'+(b.TicketType||'-')+'</td></tr>';
        }
        tbody.innerHTML = html;
        renderReportPagination(total, pages);
    }

    function renderReportPagination(total, pages) {
        var c = document.getElementById('reportPagination');
        if (!c) return;
        if (total === 0 || pages <= 1) { c.style.display = 'none'; return; }
        c.style.display = 'flex'; c.innerHTML = '';
        var prev = document.createElement('button'); prev.className = 'pagination-btn'; prev.textContent = 'Prev';
        if (reportCurrentPage > 1) { prev.onclick = function() { reportCurrentPage--; renderReportBookingHistoryPage(); }; } else { prev.style.opacity = '0.5'; prev.style.cursor = 'not-allowed'; }
        c.appendChild(prev);
        for (var i = 1; i <= pages; i++) { (function(p) { var btn = document.createElement('button'); btn.className = 'pagination-btn'+(p===reportCurrentPage?' active':''); btn.textContent = p; btn.onclick = function() { reportCurrentPage = p; renderReportBookingHistoryPage(); }; c.appendChild(btn); })(i); }
        var next = document.createElement('button'); next.className = 'pagination-btn'; next.textContent = 'Next';
        if (reportCurrentPage < pages) { next.onclick = function() { reportCurrentPage++; renderReportBookingHistoryPage(); }; } else { next.style.opacity = '0.5'; next.style.cursor = 'not-allowed'; }
        c.appendChild(next);
    }

    function updateBookingStatus(bookingId, newStatus) {
        if (!bookingId || !newStatus) return;
        fetch('/Itinerary/UpdateBookingStatus', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: 'bookingId=' + encodeURIComponent(bookingId) + '&status=' + encodeURIComponent(newStatus) })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                for (var i = 0; i < reportAllBookings.length; i++) { if (reportAllBookings[i].BookingID === bookingId) { reportAllBookings[i].Status = newStatus; break; } }
                calculateReportStatistics(); renderReportBookingHistoryPage(); updateReportDetailsFromLatest(); updateReportStatusBadge();
            } else { alert('Failed: ' + data.message); }
        })
        .catch(function(e) { alert('Error updating status.'); });
    }

    function applyReportFilters() {
        var et = document.getElementById('filter_entityType').value;
        var st = document.getElementById('filter_status').value;
        var sr = document.getElementById('report_searchInput').value.toLowerCase();
        var filtered = [];
        for (var i = 0; i < reportAllBookings.length; i++) {
            var b = reportAllBookings[i], match = true;
            if (et && b.TicketType && b.TicketType.toLowerCase() !== et.toLowerCase()) match = false;
            if (st && b.Status && b.Status.toLowerCase() !== st.toLowerCase()) match = false;
            if (sr && !((b.PassengerName||'').toLowerCase().indexOf(sr)>=0 || (b.TicketNo||'').toLowerCase().indexOf(sr)>=0 || (b.DepartureAirport||'').toLowerCase().indexOf(sr)>=0 || (b.ArrivalAirport||'').toLowerCase().indexOf(sr)>=0)) match = false;
            if (match) filtered.push(b);
        }
        var ti = 0, tr = 0, tj = 0;
        for (var i = 0; i < filtered.length; i++) { var s = (filtered[i].Status||'').toLowerCase(); if (s==='issued'||s==='approved') ti++; else if (s==='refunded') tr++; else if (s==='rejected') tj++; }
        document.getElementById('stat_totalIssued').textContent = ti;
        document.getElementById('stat_totalRefunded').textContent = tr;
        document.getElementById('stat_totalRejected').textContent = tj;
        document.getElementById('stat_totalFlights').textContent = filtered.length;
        reportCurrentPage = 1;
        renderFilteredBookings(filtered);
    }

    function renderFilteredBookings(fb) {
        var tbody = document.getElementById('reportBookingHistoryTableBody');
        if (!fb || fb.length === 0) { tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:20px;color:#6b7280;">No results found.</td></tr>'; document.getElementById('reportPagination').style.display = 'none'; return; }
        var total = fb.length, pages = Math.ceil(total / reportRecordsPerPage);
        var start = (reportCurrentPage - 1) * reportRecordsPerPage, end = Math.min(start + reportRecordsPerPage, total);
        var html = '';
        for (var i = start; i < end; i++) {
            var b = fb[i], row = i + 1;
            var fd = '-', ft = '-'; if (b.UpdatedDate) { var d = parseReportDate(b.UpdatedDate); if (d) { fd = d.toISOString().split('T')[0]; ft = d.toTimeString().split(' ')[0]; } }
            var dep = '-', ret = '-', bd = '-';
            if (b.DepartureDate) { var d = parseReportDate(b.DepartureDate); if (d) dep = d.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}); }
            if (b.ReturnDate) { var d = parseReportDate(b.ReturnDate); if (d) ret = d.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}); }
            if (b.BookingDate) { var d = parseReportDate(b.BookingDate); if (d) bd = d.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}); }
            var st = (b.Status || 'Pending').toLowerCase(), sc = 'status-pending';
            if (st === 'issued' || st === 'approved') sc = 'status-issued';
            else if (st === 'rejected') sc = 'status-rejected';
            else if (st === 'refunded') sc = 'status-refunded';
            var dd = '<select class="status-dropdown '+sc+'" onchange="updateBookingStatus('+b.BookingID+',this.value)"><option value="Pending"'+(st==='pending'?' selected':'')+'>Pending</option><option value="Issued"'+(st==='issued'?' selected':'')+'>Issued</option><option value="Approved"'+(st==='approved'?' selected':'')+'>Approved</option><option value="Rejected"'+(st==='rejected'?' selected':'')+'>Rejected</option><option value="Refunded"'+(st==='refunded'?' selected':'')+'>Refunded</option></select>';
            html += '<tr><td class="row-number">'+row+'.</td><td>'+fd+'<br/>'+ft+'</td><td><span class="route-dates">'+dep+'<br/><img src="/assets/arrowIcon.png" style="width:12px;height:12px;vertical-align:middle;margin:0 4px">'+ret+'</span></td><td>'+(b.DepartureAirport||'-')+' <img src="/assets/takeoff.png" style="width:14px;height:14px;vertical-align:middle;margin:0 2px"> <img src="/assets/landing.png" style="width:14px;height:14px;vertical-align:middle;margin:0 2px"> '+(b.ArrivalAirport||'-')+'</td><td>'+bd+'</td><td>'+dd+'</td><td>'+(b.UpdatedBy||'-')+'</td><td>'+(b.PassengerName||'-')+'</td><td class="text-center">1</td><td>'+(b.TicketType||'-')+'</td></tr>';
        }
        tbody.innerHTML = html;
        renderReportPagination(total, pages);
    }

    function renderReportPagination(total, pages) {
        var c = document.getElementById('reportPagination');
        if (!c) return;
        if (total === 0 || pages <= 1) { c.style.display = 'none'; return; }
        c.style.display = 'flex'; c.innerHTML = '';
        var prev = document.createElement('button'); prev.className = 'pagination-btn'; prev.textContent = 'Prev';
        if (reportCurrentPage > 1) { prev.onclick = function() { reportCurrentPage--; renderReportBookingHistoryPage(); }; } else { prev.style.opacity = '0.5'; prev.style.cursor = 'not-allowed'; }
        c.appendChild(prev);
        for (var i = 1; i <= pages; i++) { (function(p) { var btn = document.createElement('button'); btn.className = 'pagination-btn'+(p===reportCurrentPage?' active':''); btn.textContent = p; btn.onclick = function() { reportCurrentPage = p; renderReportBookingHistoryPage(); }; c.appendChild(btn); })(i); }
        var next = document.createElement('button'); next.className = 'pagination-btn'; next.textContent = 'Next';
        if (reportCurrentPage < pages) { next.onclick = function() { reportCurrentPage++; renderReportBookingHistoryPage(); }; } else { next.style.opacity = '0.5'; next.style.cursor = 'not-allowed'; }
        c.appendChild(next);
    }

    function updateBookingStatus(bookingId, newStatus) {
        if (!bookingId || !newStatus) return;
        fetch('/Itinerary/UpdateBookingStatus', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: 'bookingId=' + encodeURIComponent(bookingId) + '&status=' + encodeURIComponent(newStatus) })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                for (var i = 0; i < reportAllBookings.length; i++) { if (reportAllBookings[i].BookingID === bookingId) { reportAllBookings[i].Status = newStatus; break; } }
                calculateReportStatistics(); renderReportBookingHistoryPage(); updateReportDetailsFromLatest(); updateReportStatusBadge();
            } else { alert('Failed: ' + data.message); }
        })
        .catch(function(e) { alert('Error updating status.'); });
    }

    function applyReportFilters() {
        var et = document.getElementById('filter_entityType').value;
        var st = document.getElementById('filter_status').value;
        var sr = document.getElementById('report_searchInput').value.toLowerCase();
        var filtered = [];
        for (var i = 0; i < reportAllBookings.length; i++) {
            var b = reportAllBookings[i], match = true;
            if (et && b.TicketType && b.TicketType.toLowerCase() !== et.toLowerCase()) match = false;
            if (st && b.Status && b.Status.toLowerCase() !== st.toLowerCase()) match = false;
            if (sr && !((b.PassengerName||'').toLowerCase().indexOf(sr)>=0 || (b.TicketNo||'').toLowerCase().indexOf(sr)>=0 || (b.DepartureAirport||'').toLowerCase().indexOf(sr)>=0 || (b.ArrivalAirport||'').toLowerCase().indexOf(sr)>=0)) match = false;
            if (match) filtered.push(b);
        }
        var ti = 0, tr = 0, tj = 0;
        for (var i = 0; i < filtered.length; i++) { var s = (filtered[i].Status||'').toLowerCase(); if (s==='issued'||s==='approved') ti++; else if (s==='refunded') tr++; else if (s==='rejected') tj++; }
        document.getElementById('stat_totalIssued').textContent = ti;
        document.getElementById('stat_totalRefunded').textContent = tr;
        document.getElementById('stat_totalRejected').textContent = tj;
        document.getElementById('stat_totalFlights').textContent = filtered.length;
        reportCurrentPage = 1;
        renderFilteredBookings(filtered);
    }

    function renderFilteredBookings(fb) {
        var tbody = document.getElementById('reportBookingHistoryTableBody');
        if (!fb || fb.length === 0) { tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:20px;color:#6b7280;">No results found.</td></tr>'; document.getElementById('reportPagination').style.display = 'none'; return; }
        var total = fb.length, pages = Math.ceil(total / reportRecordsPerPage);
        var start = (reportCurrentPage - 1) * reportRecordsPerPage, end = Math.min(start + reportRecordsPerPage, total);
        var html = '';
        for (var i = start; i < end; i++) {
            var b = fb[i], row = i + 1;
            var fd = '-', ft = '-'; if (b.UpdatedDate) { var d = parseReportDate(b.UpdatedDate); if (d) { fd = d.toISOString().split('T')[0]; ft = d.toTimeString().split(' ')[0]; } }
            var dep = '-', ret = '-', bd = '-';
            if (b.DepartureDate) { var d = parseReportDate(b.DepartureDate); if (d) dep = d.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}); }
            if (b.ReturnDate) { var d = parseReportDate(b.ReturnDate); if (d) ret = d.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}); }
            if (b.BookingDate) { var d = parseReportDate(b.BookingDate); if (d) bd = d.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}); }
            var st = (b.Status || 'Pending').toLowerCase(), sc = 'status-pending';
            if (st === 'issued' || st === 'approved') sc = 'status-issued';
            else if (st === 'rejected') sc = 'status-rejected';
            else if (st === 'refunded') sc = 'status-refunded';
            var dd = '<select class="status-dropdown '+sc+'" onchange="updateBookingStatus('+b.BookingID+',this.value)"><option value="Pending"'+(st==='pending'?' selected':'')+'>Pending</option><option value="Issued"'+(st==='issued'?' selected':'')+'>Issued</option><option value="Approved"'+(st==='approved'?' selected':'')+'>Approved</option><option value="Rejected"'+(st==='rejected'?' selected':'')+'>Rejected</option><option value="Refunded"'+(st==='refunded'?' selected':'')+'>Refunded</option></select>';
            html += '<tr><td class="row-number">'+row+'.</td><td>'+fd+'<br/>'+ft+'</td><td><span class="route-dates">'+dep+'<br/><img src="/assets/arrowIcon.png" style="width:12px;height:12px;vertical-align:middle;margin:0 4px">'+ret+'</span></td><td>'+(b.DepartureAirport||'-')+' <img src="/assets/takeoff.png" style="width:14px;height:14px;vertical-align:middle;margin:0 2px"> <img src="/assets/landing.png" style="width:14px;height:14px;vertical-align:middle;margin:0 2px"> '+(b.ArrivalAirport||'-')+'</td><td>'+bd+'</td><td>'+dd+'</td><td>'+(b.UpdatedBy||'-')+'</td><td>'+(b.PassengerName||'-')+'</td><td class="text-center">1</td><td>'+(b.TicketType||'-')+'</td></tr>';
        }
        tbody.innerHTML = html;
        renderReportPagination(total, pages);
    }

    document.addEventListener('DOMContentLoaded', function() {
        var f1 = document.getElementById('filter_entityType'); if (f1) f1.addEventListener('change', applyReportFilters);
        var f2 = document.getElementById('filter_status'); if (f2) f2.addEventListener('change', applyReportFilters);
        var si = document.getElementById('report_searchInput');
        if (si) { var t; si.addEventListener('input', function() { clearTimeout(t); t = setTimeout(applyReportFilters, 300); }); }
    });

    document.addEventListener('keydown', function(e) { if (e.key === 'Escape' && document.getElementById('viewReportModal').style.display === 'flex') closeReportModal(); });
    document.addEventListener('click', function(e) { if (e.target === document.getElementById('viewReportModal')) closeReportModal(); });
</script>
